name: IDE Profile Updater

on:
  schedule:
    - cron: "0 * * * *" # Atualiza a cada hora
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    name: Compiling and Pushing Profile Updates
    
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Atualizar dados e fazer commit
        run: |
          node -e "
            const https = require('https'); // <--- ERRO CORRIGIDO AQUI
            const fs = require('fs');
            
            const readmePath = './README.md';
            const user = 'OliveiraStrategic';
            const maxEvents = 5;

            async function main() {
              // PARTE 1: BUSCAR ATIVIDADE DA API DO GITHUB
              const activityApiUrl = \`https://api.github.com/users/\${user}/events\`;
              let activityMarkdown = '';
              
              try {
                const eventsJson = await fetchJson(activityApiUrl);
                const recentEvents = eventsJson.slice(0, maxEvents);
                
                activityMarkdown = recentEvents.map(event => {
                  if (event.type === 'PushEvent') {
                    const commitCount = event.payload.size === 1 ? '1 commit' : \`\${event.payload.size} commits\`;
                    return \`- ‚¨ÜÔ∏è Fez push de \${commitCount} para [**\${event.repo.name}**](https://github.com/\${event.repo.name})\`;
                  } else if (event.type === 'CreateEvent' && event.payload.ref_type === 'repository') {
                    return \`- ‚ú® Criou o novo reposit√≥rio [**\${event.repo.name}**](https://github.com/\${event.repo.name})\`;
                  } else if (event.type === 'IssuesEvent' && event.payload.action === 'opened') {
                    return \`- ‚ùó Abriu a issue [#\${event.payload.issue.number}](\${event.payload.issue.html_url}) em [**\${event.repo.name}**](https://github.com/\${event.repo.name})\`;
                  } else if (event.type === 'ForkEvent') {
                    return \`- üç¥ Criou um fork de [**\${event.payload.forkee.full_name}**](\${event.payload.forkee.html_url})\`;
                  }
                  return null;
                }).filter(Boolean).join('\\n');

                if (!activityMarkdown) {
                  activityMarkdown = 'Nenhuma atividade p√∫blica recente encontrada.';
                }
              } catch (error) {
                console.error('Erro ao buscar atividade:', error.message);
                activityMarkdown = 'N√£o foi poss√≠vel carregar o stream de atividade.';
              }

              // PARTE 2: ATUALIZAR O ARQUIVO README
              let readmeContent = fs.readFileSync(readmePath, 'utf-8');

              // 2a. Atualizar Timestamp
              const options = { timeZone: 'America/Sao_Paulo', day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' };
              const date = new Date().toLocaleString('pt-BR', options);
              const finalDate = \`\${date.replace(',', '')}\`;
              readmeContent = readmeContent.replace('', finalDate);
              console.log(\`Timestamp atualizado para: \${finalDate}\`);
              
              // 2b. Atualizar Stream de Commits
              const placeholder = '<pre>// Aguardando stream de commits...</pre>';
              const finalActivity = \`<pre>\${activityMarkdown}</pre>\`;
              readmeContent = readmeContent.replace(placeholder, finalActivity);
              console.log('Stream de commits inserido com sucesso.');

              fs.writeFileSync(readmePath, readmeContent);
            }

            // Fun√ß√£o helper para fazer a chamada de API
            function fetchJson(url) {
              return new Promise((resolve, reject) => {
                const options = { headers: { 'User-Agent': 'GitHub-Action' } };
                https.get(url, options, (res) => {
                  let data = '';
                  res.on('data', (chunk) => data += chunk);
                  res.on('end', () => {
                    try {
                      if (res.statusCode >= 400) {
                        return reject(new Error(\`Falha na chamada de API com status \${res.statusCode}: \${data}\`));
                      }
                      resolve(JSON.parse(data));
                    } catch (e) {
                      reject(e);
                    }
                  });
                }).on('error', (err) => reject(err));
              });
            }

            main();
          "
      
      - name: Fazer commit final
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'chore(profile): auto-update IDE stats'
          file_pattern: README.md
