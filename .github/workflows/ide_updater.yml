name: IDE Profile Updater

on:
  schedule:
    - cron: "0 * * * *" # Atualiza a cada hora
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    name: Compiling and Pushing Profile Updates

    steps:
      - uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Gerar stream de commits
        uses: athul/gh-activity@v1.2.1 # <--- A CORREÇÃO ESTÁ AQUI
        id: activity_step
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MAX_LINES: 5

      - name: Atualizar arquivos do editor
        run: |
          node -e "
            const fs = require('fs');
            const readmePath = './README.md';
            
            // 1. Atualizar Timestamp no Footer
            const options = { timeZone: 'America/Sao_Paulo', day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' };
            const date = new Date().toLocaleString('pt-BR', options);
            const finalDate = \`\${date.replace(',', '')}\`;
            let readmeContent = fs.readFileSync(readmePath, 'utf-8');
            readmeContent = readmeContent.replace('', finalDate);
            console.log(\`Timestamp atualizado para: \${finalDate}\`);

            // 2. Atualizar Stream de Commits
            const activityMarkdown = \`\${{ steps.activity_step.outputs.activity }}\`;
            const placeholder = '<pre>// Aguardando stream de commits...</pre>';
            // Adiciona a atividade dentro de um novo <pre> para manter a formatação
            const finalActivity = \`<pre>\${activityMarkdown}</pre>\`;
            readmeContent = readmeContent.replace(placeholder, finalActivity);
            console.log('Stream de commits inserido com sucesso.');

            fs.writeFileSync(readmePath, readmeContent);
          "
      
      - name: Fazer commit das alterações
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'chore(profile): auto-update IDE stats'
          file_pattern: README.md
